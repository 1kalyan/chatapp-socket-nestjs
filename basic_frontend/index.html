<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Socket.IO Chat Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      #messages {
        border: 1px solid #ccc;
        padding: 10px;
        height: 300px;
        overflow-y: scroll;
        background: #f9f9f9;
      }
      #inputForm {
        margin-top: 10px;
      }
      input {
        padding: 5px;
        font-size: 1rem;
        width: 70%;
      }
      button {
        padding: 6px 12px;
        font-size: 1rem;
      }
    </style>
  </head>
  <body>
    <h2>ðŸ”Œ Socket.IO Chat</h2>
    <div id="messages"></div>

    <form id="inputForm">
      <input
        type="text"
        id="messageInput"
        placeholder="Type a message..."
        autocomplete="off"
        required
      />
      <button type="submit">Send</button>
    </form>

    <!-- <script>
    const socket = io('http://localhost:3754');

    const messagesDiv = document.getElementById('messages');
    const inputForm = document.getElementById('inputForm');
    const messageInput = document.getElementById('messageInput');

    function addMessage(text) {
      const p = document.createElement('p');
      p.textContent = text;
      messagesDiv.appendChild(p);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    socket.on('connect', () => {
      addMessage(`ðŸŸ¢ Connected with ID: ${socket.id}`);
    });

    socket.on('user-joined', (data) => {
      addMessage(`ðŸ”µ ${data.message}`);
    });

    socket.on('user-left', (data) => {
      addMessage(`ðŸ”´ ${data.message}`);
    });

    socket.on('message', (msg) => {
      if (typeof msg === 'object' && msg.senderId && msg.text) {
        const senderLabel = msg.senderId === socket.id ? "You" : msg.senderId;
        addMessage(`ðŸ’¬ ${senderLabel}: ${msg.text}`);
      } else {
        addMessage(`ðŸ’¬ ${msg}`);
      }
    });

    inputForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const message = messageInput.value.trim();
      if (message !== '') {
        socket.emit('newMessage', message);
        messageInput.value = '';
      }
    });
  </script> -->
    <script>
      const socket = io('http://127.0.0.1:5500');

      const messagesDiv = document.getElementById('messages');
      const inputForm = document.getElementById('inputForm');
      const messageInput = document.getElementById('messageInput');

      socket.on('disconnect', (reason) => {
        console.log('Disconnected:', reason);
      });

      socket.io.on('reconnect_attempt', (attempt) => {
        console.log('Reconnect attempt:', attempt);
      });

      let username = '';
      let usernameSet = false;

      window.onload = () => {
        // Ask for name
        username = prompt('Enter your name:') || 'Anonymous';
        // Send to server
        socket.emit('setUsername', username);
      };

      socket.on('connect', () => {
        addMessage(`ðŸŸ¢ Connected with ID: ${socket.id}`);
      });

      socket.on('user-joined', (data) => {
        addMessage(`ðŸ”µ ${data.message}`);
      });

      socket.on('user-left', (data) => {
        addMessage(`ðŸ”´ ${data.message}`);
      });

      socket.on('message', (msg) => {
        if (typeof msg === 'object' && msg.sender && msg.text) {
          const senderLabel = msg.sender === username ? 'You' : msg.sender;
          addMessage(`ðŸ’¬ ${senderLabel}: ${msg.text}`);
        } else {
          addMessage(`ðŸ’¬ ${msg}`);
        }
      });

      // Allow message sending only *after* username is set
      socket.on('username-confirmed', () => {
        usernameSet = true;
      });

      inputForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (!usernameSet) {
          alert('Please wait for username to be set before chatting.');
          return;
        }
        if (message !== '') {
          socket.emit('newMessage', message);
          messageInput.value = '';
        }
      });

      function addMessage(text) {
        const p = document.createElement('p');
        p.textContent = text;
        messagesDiv.appendChild(p);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    </script>
  </body>
</html>
